DROP DATABASE ECOMARKET_TEST;
CREATE DATABASE IF NOT EXISTS ECOMARKET_TEST;
USE ECOMARKET_TEST;

-- Eliminar tablas (MySQL no usa CASCADE CONSTRAINTS)
DROP TABLE IF EXISTS DETALLE;
DROP TABLE IF EXISTS COMPRA;
DROP TABLE IF EXISTS PRODUCTO;
DROP TABLE IF EXISTS CLIENTE;
DROP TABLE IF EXISTS SUCURSAL;
DROP TABLE IF EXISTS COMUNA;
DROP TABLE IF EXISTS REGION;

-- Crear tablas
CREATE TABLE REGION (
    ID_REGION INT PRIMARY KEY,
    NOMBRE_REGION VARCHAR(40) NOT NULL
);

CREATE TABLE COMUNA (
    ID_COMUNA INT PRIMARY KEY,
    NOMBRE_COMUNA VARCHAR(40) NOT NULL,
    ID_REGION INT NOT NULL,
    FOREIGN KEY (ID_REGION) REFERENCES REGION(ID_REGION)
);
CREATE TABLE CLIENTE (
    RUN VARCHAR(12) PRIMARY KEY,
    DV CHAR(1) NOT NULL,
    NOMBRES VARCHAR(30) NOT NULL,
    APELLIDOS VARCHAR(30) NOT NULL
);

CREATE TABLE PRODUCTO (
    ID_PRODUCTO INT AUTO_INCREMENT PRIMARY KEY,
    STOCK INT NOT NULL,
    NOMBRE_PRODUCTO VARCHAR(50) NOT NULL
);

CREATE TABLE SUCURSAL (
    ID_SUCURSAL INT PRIMARY KEY,
    DIR_SUCURSAL VARCHAR(100),
    ID_COMUNA INT,
    FOREIGN KEY (ID_COMUNA) REFERENCES COMUNA(ID_COMUNA)
);

CREATE TABLE COMPRA (
    ID_COMPRA INT PRIMARY KEY,
    FECHA_COMPRA DATE NOT NULL,
    NRO_FACTURA VARCHAR(50) NOT NULL,
    CLIENTE_RUN VARCHAR(12) NOT NULL,
    ID_SUCURSAL INT NOT NULL,
    FOREIGN KEY (CLIENTE_RUN) REFERENCES CLIENTE(RUN),
    FOREIGN KEY (ID_SUCURSAL) REFERENCES SUCURSAL(ID_SUCURSAL)
);

CREATE TABLE DETALLE (
    ID_DETALLE INT AUTO_INCREMENT PRIMARY KEY,
    CANTIDAD INT NOT NULL,
    PRECIO_UNITARIO INT(12) NOT NULL,
    MET_PAGO VARCHAR(20) NOT NULL,
    ID_COMPRA INT NOT NULL,
    ID_PRODUCTO INT NOT NULL,
    FOREIGN KEY (ID_COMPRA) REFERENCES COMPRA(ID_COMPRA),
    FOREIGN KEY (ID_PRODUCTO) REFERENCES PRODUCTO(ID_PRODUCTO)
);

-- Crear Ã­ndices
CREATE INDEX COMPRA_CLIENTE_IDX ON COMPRA(CLIENTE_RUN);
CREATE INDEX COMPRA_FECHA_IDX ON COMPRA(FECHA_COMPRA);